```plaintext
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣿⣿⣿⣦⠀⠀⠀⠀⠀⠀⠀⠀⠘⣿⣿⣿⣿⣿⣿⣆⠀⠀⠀⠀⠀⢀⣼⣿⣿⣿⣆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠐⣿⣿⣿⣿⣿⣷⡀⠀⠀⠀⠀⠀⠀⠀⠈⢿⣿⣿⣿⣿⣿⣦⠀⠀⠀⢠⣾⣿⣿⣿⣿⣿⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢿⡿⢀⠹⣿⣷⡄⠀⠀⠀⠀⠀⠀⠀⠈⢻⣿⣿⣿⣿⣿⣧⡀⣠⣿⣿⣿⣿⣿⣿⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⡄⠈⠇⣼⣆⢻⡇⢬⡀⠀⠀⠀⠀⠀⠀⠀⠀⠻⠂⣼⡆⢿⣿⣷⣿⣿⣿⣿⣿⡿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣀⣀⡀⢺⠷⢀⣀⠛⡏⣠⣇⠘⢻⡁⣀⣀⣀⠀⣴⡶⢿⣿⠿⣶⣦⣄⠳⣶⣶⣮⣭⡛⠿⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣠⣷⣿⣿⢁⡇⣼⣾⣿⠀⡇⢹⣿⣿⡆⢳⡘⣿⣿⠀⣿⡾⢛⢉⣤⣤⣤⣍⡓⢌⠻⣿⣿⣿⣦⡀⠀⠀⠀⠀⠀⠀⢠⣆⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣰⣿⣿⣿⣿⢸⡇⣿⣿⣿⠀⣧⢸⣿⣿⣷⢸⡇⢹⣿⣧⡙⣨⡹⣿⣿⣿⣿⣯⣝⢮⢳⡽⣿⣿⣿⡿⠄⠀⠀⠀⠀⣰⣿⣿⣆⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠈⠉⠉⠉⠉⠉⠘⣧⡈⠉⠉⡁⣿⢈⣉⠉⢁⣼⠇⠈⠉⠉⢱⡿⢳⣿⢟⣵⣶⣶⡹⢸⠀⣷⣾⣿⢁⣶⣶⣶⣶⠃⣴⣿⣿⣿⣿⣧⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠻⠷⢶⣶⣿⣶⠶⢾⠛⠁⡀⠀⣰⣾⣮⠡⣇⣿⣿⣿⠿⢧⡞⢸⣿⣿⣿⣜⠻⠿⠟⢋⣼⣿⣿⣿⣿⣿⠋⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣾⣷⣶⢸⡇⣿⠏⠀⠀⠉⠲⣄⢴⣶⣶⣎⠋⣿⣿⡇⢡⣿⡇⣿⣿⣿⣿⣿⣿⠇⢀⣾⣿⣿⣿⣿⡿⠃⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣿⣿⣿⣿⣸⡇⠋⠀⠀⠀⠀⠀⠈⠳⣿⣷⣼⣿⣦⣭⡛⢛⢿⢸⣿⣿⣿⡿⢟⡉⢠⣿⣿⣿⣿⣿⡿⠁⠀⠀⠀⠀⠀⠀⠀⠀
⠀⣴⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣾⣿⣿⣿⣿⣿⡇⣇⠀⠀⠀⠀⠀⠀⠀⣸⢠⣭⣉⠉⣽⠎⢔⣢⡾⢸⣿⡇⠁⢶⠏⣰⣿⣿⣿⣿⣿⣿⣷⣶⣶⣶⣶⣶⣶⣶⣆⠀
⢼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⣥⢋⣤⡀⠀⠀⠀⠀⠀⡻⠈⠻⠟⣃⣠⡖⠁⠀⠀⢸⣿⣇⠀⠀⣴⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇
⠀⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⢀⢚⢠⢘⣿⣦⣀⣀⣤⣶⣯⣿⣷⣾⣿⣿⣿⣷⣄⠀⢸⣿⣿⠆⢸⣿⣿⣿⣿⣿⠿⠿⠿⠿⠿⠿⠿⠿⠿⠿⠿⠏⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢠⣾⣿⣿⣿⣿⣿⠏⣰⣿⡆⢵⡄⢻⣿⣿⣿⣿⣳⣿⣿⣿⣿⡏⣟⢿⣿⣿⣷⣄⠀⢀⣾⣿⣿⣿⣿⡿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣠⣿⣿⣿⣿⣿⣿⠋⢴⣿⣿⡇⢸⡇⠌⠻⣿⠿⢳⣿⣿⣿⣿⣿⣷⢻⣦⡝⠻⣿⣿⡆⢻⣿⣿⣿⣿⡿⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⣰⣿⣿⣿⣿⣿⡿⠃⠀⠀⢻⣿⣇⢸⡇⢸⢂⠀⠀⣾⣿⣿⣿⣿⣿⣿⣟⣿⣷⡝⣾⠿⣣⣿⣿⣿⣿⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢿⣿⣿⣿⣿⡿⠁⠀⠀⠀⠀⠱⣻⢸⣧⢸⣿⣦⠀⢿⣿⣿⣿⣿⣿⣿⣿⢻⣿⣿⣆⢤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⣤⡄⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⢻⣿⣿⡟⠀⠀⠀⠀⠀⠀⠀⠙⠀⣿⠘⣿⡿⢃⣜⣿⣿⣿⣿⣿⣿⡿⣹⣿⣿⣿⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠹⠏⠀⠀⠀⠀⠀⠀⠀⠀⣰⠀⣿⠀⣿⠁⣿⣿⣮⡻⣿⣿⡿⣫⣾⣿⣿⣿⡿⣾⡿⢟⣛⣿⣭⣽⣿⡻⣿⣿⣿⣿⣿⠟⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣴⣽⡇⣿⡄⠋⡁⠬⢝⣛⣻⣳⣯⢱⣿⣿⣿⣿⣏⢾⣦⣝⣻⣿⣿⣿⡯⠛⠉⠉⠉⠉⠉⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⣿⣿⡇⠻⠃⠈⠔⠚⣈⣋⣭⣅⠀⣀⠘⠛⠿⠿⠿⠀⠰⣶⣶⣶⣾⣿⣷⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⣿⣿⣿⣿⡯⠃⠀⠩⣿⣿⣿⣿⣷⢬⠀⠊⠁⠰⠟⠀⠀⠀⠙⣿⣿⣿⣿⣿⣿⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⣿⣿⣿⣿⣿⡿⠁⠀⠀⠀⠙⡿⣿⣿⣿⣷⣧⡀⠀⠀⠀⠀⠀⠀⠀⠘⢿⣿⣿⣿⣿⣿⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣽⣿⣿⠟⠀⠀⠀⠀⠀⠀⠘⠿⢿⣿⣿⣿⡵⡀⠀⠀⠀⠀⠀⠀⠀⠈⢿⣿⣿⣿⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
```

# NixOS Configurations Flake

Personal NixOS and nix-darwin system configurations managed as a Flake, featuring declarative disk management, ZFS with impermanence, LUKS encryption, and an iterative modular design.

## Features

- **"Stew" (Hub & Spoke) Refactoring**: An iterative code organization strategy that prevents premature optimization by starting with monolithic domain files (`stew.nix`) and splitting into dedicated modules as complexity grows.
- **Declarative Disk Management**: Automated partitioning with [Disko](https://github.com/nix-community/disko).
- **ZFS Root with Impermanence**: Ephemeral root that rolls back to `zroot/root@blank` snapshot on boot.
- **LUKS Encryption**: Full-disk encryption with systemd in initrd.
- **Multi-OS / Multi-Arch Support**: Modular configurations spanning x86_64 NixOS, riscv64 NixOS, and aarch64 macOS.
- **Persistent State Management**: Selective persistence with proper directory creation.
- **Secret Management**: Encrypted secrets via agenix stored directly in the repository.

## Hosts

| Hostname | Type | Architecture | Storage |
|----------|------|--------------|---------|
| Proteus-Desktop | Workstation | x86_64-linux | ZFS on LUKS |
| Proteus-NUC | Home Server | x86_64-linux | ZFS on LUKS |
| Proteus-NixOS-* | VPS Instances | x86_64-linux | Btrfs |
| Proteus-MBP14M4P| Laptop | aarch64-darwin| APFS |
| Proteus-VF2 | SBC | riscv64-linux | Btrfs (TODO) |

## Installation

### Prerequisites

- NixOS minimal installer ISO or [nixos-anywhere](https://github.com/nix-community/nixos-anywhere)
- Target disk ID (e.g., `/dev/disk/by-id/*`)

### Steps

1. **Clone this repository:**
  ```bash
  git clone --depth=1 https://github.com/magic0whi/nixos_configs_flake.git
  cd nixos_configs_flake
  ```
2. **Review and customize disko configuration:**
  ```bash
  hx machines/<system>/<hostname>/disko-config.nix
  ```
3. **Generate & Modify `hardware-configuration.nix`**
  ```bash
  sudo nixos-generate-config --show-hardware-config
  ```
4. **Install NixOS:**
  ```bash
  sudo nixos-install --flake .#<hostname>
  ```
5. **Move critical files to `/mnt/persistent`:**
  ```bash
  sudo mv /mnt/etc/ssh/* /mnt/persistent/etc/ssh/
  sudo mv /mnt/etc/machine-id /mnt/persistent/etc/machine-id
  sudo mv /mnt/var/l{ib,og} /mnt/persistent/var/
  ```

Or use `nixos-anywhere` for unattended installation:
```bash
nix run nixpkgs#nixos-anywhere -- -f .#Proteus-NixOS-6 \
--phases kexec root@100.126.174.68 \
--kexec https://gh-proxy.org/https://github.com/nix-community/nixos-images/releases/download/nixos-25.05/nixos-kexec-installer-noninteractive-x86_64-linux.tar.gz
nix run nixpkgs#nixos-anywhere -- -f .#Proteus-NixOS-6 --phases disko --disko-mode format root@100.126.174.68
nix run nixpkgs#nixos-anywhere -- -f .#Proteus-NixOS-6 --phases disko --disko-mode mount root@100.126.174.68
nix run nixpkgs#nixos-anywhere -- -f .#Proteus-NixOS-6 --phases install root@100.126.174.68
# Check everything ok, then move critical files to `/mnt/persistent`, see above
# Finally reboot
nix run nixpkgs#nixos-anywhere -- -f .#Proteus-NixOS-6 --phases reboot root@100.126.174.68
```

## Usage

### Updating the system

```bash
nix flake update
just <host nickname>
```

### Remote deployment

```bash
deploy [-s] --targets \
  /home/proteus/nixos_configs_flake#Proteus-NUC \
  /home/proteus/nixos_configs_flake#Proteus-Desktop \
  /home/proteus/nixos_configs_flake#Proteus-NixOS-{1..6} \
-- --show-trace --verbose
```

### List ZFS volumes

```bash
zfs list -o name,mountpoint,encryption,canmount,mounted -t filesystem,snapshot
```

## Structure

The repository is organized to separate machine-specific hardware configurations from reusable system modules.
```plaintext
.
├── flake.nix                  # Main flake configuration
├── Justfile                   # Command runner shortcuts
├── machines/                  # Host-specific configurations grouped by architecture
│   ├── aarch64-darwin/        # macOS hosts (e.g., Proteus-MBP14M4P)
│   ├── riscv64-linux/         # RISC-V SBCs
│   └── x86_64-linux/          # Workstations, servers, and VPS nodes
├── modules/                   # Reusable configurations
│   ├── common*/               # Shared across OSes (gui/headless)
│   ├── darwin*/               # nix-darwin specific modules
│   ├── nixos_*/               # NixOS specific modules (system and home-manager)
│   └── overlays/              # Custom packages (e.g., wechat, qq)
├── secrets/                   # Agenix encrypted secrets and keys
└── vars/                      # Global variables and networking definitions
```

## Key Design Decisions

### The "Stew" (Hub & Spoke) Code Organization

To avoid the cognitive overhead of premature file fragmentation, this repository utilizes an organic "Hub and Spoke" module strategy. New packages, services, or configurations for a specific domain (like `modules/nixos_headless/`) are initially dropped into a centralized `stew.nix` file.

As specific logical units within the stew grow large or complex (e.g., a massive Hyprland config or specific development environments), they are extracted into their own dedicated files (the "spokes") within that directory.

### Ephemeral Root

The root filesystem (`zroot/root`) is rolled back to a blank snapshot on every boot via systemd in initrd. This ensures a clean slate while persistent data lives in `/persistent`.

```nix
boot.initrd.systemd.services."zfs-rollback-root" = {
  description = "Rollback zroot/root@blank in initrd";
  wantedBy = ["zfs-import.target"];
  after = ["zfs-import-zroot.service"]; # Make sure zroot is imported
  before = ["sysroot.mount"]; # Make sure this happens before root is mounted
  serviceConfig = {
    Type = "oneshot";
    ExecStart = "${config.boot.zfs.package}/sbin/zfs rollback -r zroot/root@blank";
  };
};
```

### LUKS + ZFS

Each NVMe drive has a LUKS container, then ZFS pools are created across the unlocked devices for redundancy and flexibility (RAID-0 striping for performance or raidz2 for balanced performance & redundancy).

### Quick Debug

Use the first machine as-is:
```bash
nix-repl> (builtins.head _DEBUG.nixos_systems.x86_64-linux._DEBUG.machines)._DEBUG.myvars.networking.hosts_addr.Proteus-NUC.ipv4
```

Or find the specific machine:
```bash
nix-repl> (builtins.elemAt _DEBUG.nixos_systems.x86_64-linux._DEBUG.machines 1)._DEBUG.name
"Proteus-NUC"
```

## License

MIT

## References

- [NixOS](https://nixos.org/) - Declarative Linux distribution
- [ZFS - Official NixOS Wiki](https://wiki.nixos.org/wiki/ZFS) - Copy-on-write filesystem with snapshots
- [Disko](https://github.com/nix-community/disko) - Declarative disk partitioning
- [nixos-anywhere](https://github.com/nix-community/nixos-anywhere) - Install NixOS everywhere via SSH
- [impermanence](https://github.com/nix-community/impermanence) - Stateless root pattern
- [deploy-rs](https://github.com/serokell/deploy-rs) - A simple multi-profile Nix-flake deploy tool
- [sing-box](https://github.com/SagerNet/sing-box) - Universal transparent proxy platform
- [Graham Christensen's "Erase Your Darlings"](https://grahamc.com/blog/erase-your-darlings)

## Acknowledgments

Inspired by:
- [NixOS & Flakes Book](https://nixos-and-flakes.thiscute.world/)
- [ryan4yin/nix-config](https://github.com/ryan4yin/nix-config)

ASCII Logo:
- [darwin-nix](https://github.com/nix-darwin/nix-darwin)
